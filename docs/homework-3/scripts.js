"use strict";var _createClass=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}window.$clamp=function(r,t){function i(t,e){return l.getComputedStyle||(l.getComputedStyle=function(i,t){return this.el=i,this.getPropertyValue=function(t){var e=/(\-([a-z]){1})/g;return"float"==t&&(t="styleFloat"),e.test(t)&&(t=t.replace(e,function(t,e,i){return i.toUpperCase()})),i.currentStyle&&i.currentStyle[t]?i.currentStyle[t]:null},this}),l.getComputedStyle(t,null).getPropertyValue(e)}function e(t){t=t||r.clientHeight;var e=n(r);return Math.max(Math.floor(t/e),0)}function n(t){var e=i(t,"line-height");return"normal"==e&&(e=1.2*parseInt(i(t,"font-size"))),parseInt(e)}function o(t){return t.lastChild.children&&0<t.lastChild.children.length?o(Array.prototype.slice.call(t.children).pop()):t.lastChild&&t.lastChild.nodeValue&&""!=t.lastChild.nodeValue&&t.lastChild.nodeValue!=h.truncationChar?t.lastChild:(t.lastChild.parentNode.removeChild(t.lastChild),o(r))}function a(t,e){t.nodeValue=e+h.truncationChar}t=t||{};var s,l=window,h={clamp:t.clamp||2,useNativeClamp:void 0===t.useNativeClamp||t.useNativeClamp,splitOnChars:t.splitOnChars||[".","-","–","—"," "],animate:t.animate||!1,truncationChar:t.truncationChar||"…",truncationHTML:t.truncationHTML},c=r.style,u=r.innerHTML,d=void 0!==r.style.webkitLineClamp,p=h.clamp,v=p.indexOf&&(-1<p.indexOf("px")||-1<p.indexOf("em"));h.truncationHTML&&((s=document.createElement("span")).innerHTML=h.truncationHTML);var m,g,f,C,y=h.splitOnChars.slice(0),w=y[0];return"auto"==p?p=e():v&&(p=e(parseInt(p))),d&&h.useNativeClamp?(c.overflow="hidden",c.textOverflow="ellipsis",c.webkitBoxOrient="vertical",c.display="-webkit-box",c.webkitLineClamp=p,v&&(c.height=h.clamp+"px")):(C=p,(c=n(r)*C)<=r.clientHeight&&(f=function t(e,i){if(i){var n=e.nodeValue.replace(h.truncationChar,"");if(m||(w=0<y.length?y.shift():"",m=n.split(w)),1<m.length?(g=m.pop(),a(e,m.join(w))):m=null,s&&(e.nodeValue=e.nodeValue.replace(h.truncationChar,""),r.innerHTML=e.nodeValue+" "+s.innerHTML+h.truncationChar),m){if(r.clientHeight<=i){if(!(0<=y.length&&""!=w))return r.innerHTML;a(e,m.join(w)+w+g),m=null}}else""==w&&(a(e,""),e=o(r),y=h.splitOnChars.slice(0),w=y[0],g=m=null);if(!h.animate)return t(e,i);setTimeout(function(){t(e,i)},!0===h.animate?10:h.animate)}}(o(r),c))),{original:u,clamped:f}};var globalHelper={getViewPortSizes:function(){return[Math.max(document.documentElement.clientWidth,window.innerWidth||0),Math.max(document.documentElement.clientHeight,window.innerHeight||0)]},checkTouchDevice:function(){var t=" -webkit- -moz- -o- -ms- ".split(" ");if("ontouchstart"in window)return!0;var e,i=["(",t.join("touch-enabled),("),"heartz",")"].join("");return e=i,window.matchMedia(e).matches},clampTitles:function(){document.querySelectorAll(".card_header__title > h3").forEach(function(t){$clamp(t,{clamp:2,useNativeClamp:!0})})}};function toggleHeader(){if(globalHelper.getViewPortSizes()[0]<630){var t=document.querySelectorAll(".menu_list_header")[0];t.classList.contains("animation_slide_on")?(t.classList.remove("animation_slide_on"),t.classList.add("animation_slide_off"),setTimeout(function(){t.classList.remove("animation_slide_off","menu_list_item_header--active")},300)):t.classList.add("animation_slide_on","menu_list_item_header--active")}}globalHelper.clampTitles();var menuContainer=document.querySelector(".header__container");menuContainer&&menuContainer.addEventListener("click",toggleHeader);var CameraController=function(){function i(t,e){if(_classCallCheck(this,i),this.streamUrl=e,this.animationLength=250,this.animationStart=!1,this.video=t,this.videoWrapper=this.video.parentElement,!this.videoWrapper)throw Error("Vide wrapper doesn`t exist");if(this.cardContainer=this.videoWrapper.parentElement,this.cardsContainer=this.cardContainer.parentElement,!this.cardContainer||!this.cardsContainer||!this.videoWrapper)throw Error("Bad params");if(this.videoControllers=this.videoWrapper.lastElementChild,!this.videoControllers.firstElementChild||!this.videoControllers.lastElementChild)throw Error("Bad videoControllers");this.brightController=this.videoControllers.firstElementChild.children[0],this.contrastController=this.videoControllers.firstElementChild.children[1],this.soundLevelController=this.videoControllers.lastElementChild.children[0],this.backButtonController=this.videoControllers.lastElementChild.children[1],this.brightness=100,this.contrast=100,this.opened=!1,this.containerSize={calculated:!1,generalContainer:{top:0,left:0,width:0,height:0},videoContainer:{top:0,left:0,width:0,height:0}},this.hlsSupported=Hls.isSupported(),this.init()}return _createClass(i,[{key:"init",value:function(){var t=this;this.startStream(this.streamUrl),this.defineAnimationDirections(),this.changeBrightness(this.brightness),this.video&&(this.video.addEventListener("click",function(){t.opened?t.close():t.open()}),window.addEventListener("resize",this.onResize.bind(this),!1)),this.brightController&&this.brightController.addEventListener("change",this.onBrightnessChange.bind(this)),this.contrastController&&this.contrastController.addEventListener("change",this.onContrastChange.bind(this)),this.backButtonController&&this.backButtonController.addEventListener("click",this.close.bind(this))}},{key:"initAudioAnalyser",value:function(){var t=this,e=window.AudioContext||window.webkitAudioContext;this.audioCtx=new e,this.node=this.audioCtx.createScriptProcessor(2048,1,1),this.analyser=this.audioCtx.createAnalyser(),this.analyser.smoothingTimeConstant=.3,this.analyser.fftSize=512,this.bands=new Uint8Array(this.analyser.frequencyBinCount),this.source=this.audioCtx.createMediaElementSource(this.video),this.source.connect(this.analyser),this.analyser.connect(this.node),this.node.connect(this.audioCtx.destination),this.source.connect(this.audioCtx.destination),this.node.onaudioprocess=function(){t.analyser.getByteFrequencyData(t.bands)}}},{key:"toggleVisualizateSound",value:function(){var e=this;this.timer?(clearInterval(this.timer),this.timer=null):this.timer=window.setInterval(function(){var t=e.getAverageFromArray(e.bands);if(!e.soundLevelController)throw Error();e.soundLevelController.style.height=t+20+"px",e.soundLevelController.innerHTML=String(e.getAverageFromArray(e.bands))},100)}},{key:"getAverageFromArray",value:function(t){var e=t.reduce(function(t,e){return t+e});return 0<e?Math.round(e/t.length):0}},{key:"startStream",value:function(t){var e=this;if(this.hlsSupported)try{this.hls=new Hls,this.hls.loadSource(t),this.hls.attachMedia(this.video),this.hls.on(Hls.Events.MANIFEST_PARSED,function(){e.video.play()})}catch(t){console.log(t)}else this.video.canPlayType("application/vnd.apple.mpegurl")&&(this.video.src=t,this.video.addEventListener("loadedmetadata",function(){e.video.play()}))}},{key:"changeQualityStream",value:function(t){if(this.hlsSupported)try{var e=Object.keys(this.hls.levels);this.hls.nextLevel=t?Number(e[e.length-1]):Number(e[0])}catch(t){console.log(t)}}},{key:"open",value:function(){var t=this;this.opened||this.animationStart||(this.animationStart=!0,this.toggleTranslate(),this.setContainerTransform(),this.toggleOpenClassName(),setTimeout(function(){t.opened=!0,t.animationStart=!1,t.toggleTranslate(),t.toggleCameraControllers(),t.changeQualityStream(!0),!t.source&&t.initAudioAnalyser(),t.toggleVisualizateSound()},this.animationLength))}},{key:"close",value:function(){var t=this;this.opened&&!this.animationStart&&(this.animationStart=!0,this.videoWrapper.style.transform=null,this.toggleTranslate(),this.toggleCameraControllers(),this.toggleVisualizateSound(),setTimeout(function(){t.toggleOpenClassName(),t.toggleTranslate(),t.changeQualityStream(!1),t.opened=!1,t.animationStart=!1},this.animationLength))}},{key:"toggleCameraControllers",value:function(){this.videoControllers.classList.contains("camera_controllers--opened")?this.videoControllers.classList.remove("camera_controllers--opened"):this.videoControllers.classList.add("camera_controllers--opened")}},{key:"toggleTranslate",value:function(){this.videoWrapper.style.transition?this.videoWrapper.style.transition=null:this.videoWrapper.style.transition="transform  "+this.animationLength/1e3+"s ease-out"}},{key:"toggleOpenClassName",value:function(){this.videoWrapper.classList.contains("opened")?this.videoWrapper.classList.remove("opened"):this.videoWrapper.classList.add("opened")}},{key:"setContainerTransform",value:function(){var t=this._calculateTransformParams();this.videoWrapper.style.transform="scale("+t.scale+") translate("+this.directionX*t.translateX+"px,"+this.directionY*t.translateY+"px)"}},{key:"onResize",value:function(){this.opened&&this.setContainerTransform()}},{key:"onBrightnessChange",value:function(t){var e=2*Number(t.target.value);this.changeBrightness(e)}},{key:"changeBrightness",value:function(t){this.brightness=t,this.video.style.filter="brightness("+t+"%) contrast("+this.contrast+"%)"}},{key:"onContrastChange",value:function(t){var e=2*Number(t.target.value);this.changeContrast(e)}},{key:"changeContrast",value:function(t){this.contrast=t,this.video.style.filter="brightness("+this.brightness+"%) contrast("+t+"%)"}},{key:"defineAnimationDirections",value:function(){this.containerSize.calculated||this._calculateTransformParams();var t=this.containerSize.generalContainer.left+this.containerSize.generalContainer.width/2,e=this.containerSize.generalContainer.top+this.containerSize.generalContainer.height/2,i=this.containerSize.videoContainer.left+this.containerSize.videoContainer.width/2,n=this.containerSize.videoContainer.top+this.containerSize.videoContainer.height/2;this.directionX=t<i?-1:1,this.directionY=e<n?-1:1}},{key:"_calculateTransformParams",value:function(){var t=this.cardContainer.getBoundingClientRect(),e=this.cardsContainer.getBoundingClientRect(),i={top:t.top,left:t.left,width:t.width,height:t.height},n={top:e.top,left:e.left,width:e.width,height:e.height};this.containerSize={calculated:!0,videoContainer:i,generalContainer:n};var r=Math.ceil(n.width/i.width*10)/10;return{scale:r,translateX:Math.ceil(i.width*(r-1)/4-Math.ceil((i.width*r-n.width)/2)),translateY:Math.ceil(i.height*(r-1)/4-Math.ceil((i.height*r-n.height)/2))}}}]),i}(),cameras=document.querySelectorAll(".camera video"),streams=["http://localhost:9191/master?url=http%3A%2F%2Flocalhost%3A3102%2Fstreams%2Fsosed%2Fmaster.m3u8","http://localhost:9191/master?url=http%3A%2F%2Flocalhost%3A3102%2Fstreams%2Fcat%2Fmaster.m3u8","http://localhost:9191/master?url=http%3A%2F%2Flocalhost%3A3102%2Fstreams%2Fdog%2Fmaster.m3u8","http://localhost:9191/master?url=http%3A%2F%2Flocalhost%3A3102%2Fstreams%2Fhall%2Fmaster.m3u8"];if(cameras.forEach(function(t,e){return new CameraController(t,streams[e])}),globalHelper.checkTouchDevice()){var touchElements=document.querySelector(".touch_elements");touchElements&&(touchElements.style.display="flex")}var menuItems=document.querySelectorAll(".menu_list_item_header");function onMenuItemClick(t){if(document.querySelectorAll(".menu_list_item_header--active")[0].classList.remove("menu_list_item_header--active"),t.target.parentElement){var e=t.target.parentElement;e&&e.classList.add("menu_list_item_header--active")}toggleHeader(),t.stopPropagation()}menuItems.forEach(function(t){t.addEventListener("click",onMenuItemClick,!0)});var ImageTouchEvents=function(){function n(t,e){var i=this;if(_classCallCheck(this,n),!(this.image=t).parentElement)throw new Error("Can't find parent for image");this.parent=t.parentElement,this.image.onload=function(){i.initListeners(),i.initState(),i.initOutput(e)}}return _createClass(n,[{key:"initListeners",value:function(){var e=this;this.image.addEventListener("pointerdown",function(t){e.image.setPointerCapture(t.pointerId),e.addTouchPointer(t)}),this.image.addEventListener("pointermove",function(t){e.activePoints[t.pointerId]&&e.calculateTouchCore(t)}),this.image.addEventListener("pointercancel",function(t){return e.removeTouchPointer(t)}),this.image.addEventListener("pointerup",function(t){return e.removeTouchPointer(t)})}},{key:"initState",value:function(){var t=this.image.getBoundingClientRect();this.activePoints={},this.options={maxScrollX:t.right-t.left-this.parent.offsetWidth,maxScrollY:t.bottom-t.top-this.parent.offsetHeight,width:t.right-t.left,height:t.bottom-t.top,startX:0,startY:0,prevX:0,prevY:0,currentTouchAction:null,currentBgFilter:100,zoomCurrent:1,zoomMax:2,zoomMin:1}}},{key:"setIfExist",value:function(t){var e=document.querySelector(t);if(e)return e;throw Error("Can't find element by selector "+t+" ")}},{key:"initOutput",value:function(t){var e=this;function i(e,i){return function(t){e.innerHTML=Math.abs(Math.round(t/i*100))+"%"}}this.output={zoom:this.setIfExist(t.zoom),bright:this.setIfExist(t.bright),vMove:this.setIfExist(t.vMove),hMove:this.setIfExist(t.hMove)},this.triggers={zoomCurrent:i(e.output.zoom,1),prevX:i(e.output.vMove,e.options.maxScrollX),prevY:i(e.output.hMove,e.options.maxScrollY),currentBgFilter:i(e.output.bright,100)}}},{key:"setOption",value:function(t,e){this.options[t]=e,this.triggers[t]&&e&&"string"!=typeof e&&this.triggers[t](e)}},{key:"getOption",value:function(t){return this.options[t]}},{key:"addTouchPointer",value:function(t){1<Object.keys(this.activePoints).length||(this.activePoints[t.pointerId]={prevX:t.x,prevY:t.y,startX:t.x,startY:t.y,prevTs:Date.now()})}},{key:"removeTouchPointer",value:function(t){this.setOption("currentTouchAction",null),delete this.activePoints[t.pointerId]}},{key:"calculateTouchCore",value:function(t){var e=this;if(this.activePoints[t.pointerId]){var i=this.activePoints[t.pointerId],n=Date.now();if(4<n-i.prevTs){var r=t.x,o=t.y,a=this.getOption("prevY"),s=this.getOption("prevX"),l={detX:r-i.prevX,detY:o-i.prevY,currentPoint:i,secondPoint:this.getSecondPoint(t.pointerId),newPoint:{prevY:o,prevX:r,prevTs:n,startX:r,startY:o}},h=function(){e.activePoints[t.pointerId]=l.newPoint},c=a+l.detY,u=s+l.detX,d=this.actionResolver(l);if(null!==d)switch(this.setOption("currentTouchAction",d),d){case"swipe":this.handleSwipe(u,c,l.detY),h();break;case"pinch":this.handlePinch(l.currentPoint,l.newPoint,l.secondPoint),h();break;case"rotate":this.handleRotate(l.detX,l.detY);default:return}}}}},{key:"calculateAngle",value:function(t,e,i){var n=void 0,r=void 0,o=void 0;return t.prevX-e.prevX+t.prevY-t.prevY?(r={x:t.prevX-i.prevX,y:t.prevY-i.prevY},o={x:e.prevX-i.prevX,y:e.prevY-i.prevY},n=(r.x*o.x+r.y*o.y)/Math.sqrt(Math.pow(r.x,2)+Math.pow(r.y,2))/Math.sqrt(Math.pow(o.x,2)+Math.pow(o.y,2)),180*Math.acos(n)/Math.PI):1}},{key:"actionResolver",value:function(t){var e=this.getOption("currentTouchAction"),i=Object.keys(this.activePoints).length;if(null!==e)return e;if(1===i)this.setOption("currentTouchAction","swipe"),e="swipe";else if(2===i&&30<Math.abs(t.detX)+Math.abs(t.detY)&&t.secondPoint){var n=this.calculateAngle(t.currentPoint,t.newPoint,t.secondPoint);e=Math.abs(n)<7?(this.setOption("currentTouchAction","pinch"),"pinch"):(this.setOption("currentTouchAction","rotate"),"rotate")}return e}},{key:"getSecondPoint",value:function(t){for(var e in this.activePoints)if(this.activePoints.hasOwnProperty(e)&&Number(e)!==Number(t))return this.activePoints[e]}},{key:"handleSwipe",value:function(t,e,i){t<=0&&Math.abs(t)<=this.getOption("maxScrollX")&&(this.image.style.left=t+"px",this.setOption("prevX",t)),(i<0&&0<=Math.abs(e)||0<i&&e<=0)&&Math.abs(e)<=this.getOption("maxScrollY")&&(this.image.style.top=e+"px",this.setOption("prevY",e))}},{key:"handlePinch",value:function(t,e,i){var n={x:t.prevX-i.prevX,y:t.prevY-i.prevY},r={x:e.prevX-i.prevX,y:e.prevY-i.prevY},o=Math.sqrt(Math.pow(n.x,2)+Math.pow(n.y,2)),a=void 0;a=0<Math.sqrt(Math.pow(r.x,2)+Math.pow(r.y,2))-o?Math.min(this.getOption("zoomMax"),this.getOption("zoomCurrent")+.04):Math.max(this.getOption("zoomMin"),this.getOption("zoomCurrent")-.04),this.setOption("zoomCurrent",a),this.image.style.zoom=a+"%"}},{key:"handleRotate",value:function(t,e){var i=180*Math.atan(t/e)/Math.PI,n=void 0;n=i<0?Math.max(1,this.getOption("currentBgFilter")+i/15):Math.min(100,this.getOption("currentBgFilter")+i/15),this.setOption("currentBgFilter",n),this.image.style.filter="brightness("+n+"%)"}}]),n}(),image=document.querySelectorAll("#touch-image > img")[0],options={bright:"#bright",zoom:"#zoom",vMove:"#vMove",hMove:"#hMove"};image&&new ImageTouchEvents(image,options);